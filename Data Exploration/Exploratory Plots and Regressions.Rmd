---
title: "Exploratory Plots"
output: html_document
---

```{r warning = FALSE, message = FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
```


```{r}
daily <- read.csv('aggragate_daily_data_2000to2020.csv')
daily <- daily %>% mutate(date = as.Date(daily$date)) %>% select(-'X')
daily <- daily %>%  mutate(year =  year(ymd(daily$date)), month = month(ymd(daily$date)), day =day(ymd(daily$date)))
daily %>%  head()
```
```{r}
model_1 <- lm(energy_generated ~ water_level + month, daily)
summary(model_1)
```

```{r}
library(plotly)
plot_ly(x=daily$water_level, y=daily$month, z=daily$energy_generated, type="scatter3d", mode="markers", color = daily$month)
```


```{r}
model_2<- lm(poured_flow ~  lag(water_level,14) +  lag(water_level,15), daily)
summary(model_2)
```

```{r}
library(plotly)
plot_ly(x=lag(daily$water_level,14), y=lag(daily$water_level,15), z=daily$poured_flow, type="scatter3d", mode="markers", color = lag(daily$poured_flow,2))
```

```{r}
model_3<- lm(poured_flow ~  lag(water_level,14) +  lag(poured_flow,2), daily)
summary(model_3)
```

The plot below shows that even with a 30 day lag on water level, there is almost no poured flow if the water level is at or below 446. With a 14 day lag, the 447 mark seems like a cutoff.
```{r}
plot_ly(x=lag(daily$water_level,14), y=lag(daily$water_level,30), z=daily$poured_flow, type="scatter3d", mode="markers", color = lag(daily$influent_flow,2))

daily %>%  ggplot(aes(x = lag(water_level,30), y = poured_flow, color = influent_flow)) + geom_point()
```

Here I compare two models: one with the 14 day waterlevel lag, and one that cuts off all the days with low water levels.
```{r}
model_4<- lm(poured_flow ~  lag(water_level,14) +  lag(influent_flow,2), daily)
summary(model_4)
```
```{r}
model_6<- lm(poured_flow ~ lag(influent_flow,2), filter(daily, lag(water_level,14) >446))
summary(model_6)
for (i in list(1,2,3,4,5,6,7,8,9,10,11,12)){
  print(daily %>% filter(lag(water_level,14)>446, month ==i)  %>% ggplot( aes(y = poured_flow, x=lag(influent_flow,2),color=month)) + 
    geom_point() + 
    stat_smooth(method="lm", se=FALSE))
}

```
The plots above make me thing that poured flow is always kinda sporadic. In any given month there can be some poured flow. However, in some months the purpose of poured flow is not to drain the reservoir: see months 7,8,10,11.

```{r}
plot_ly(x=lag(daily$influent_flow,2), y=lag(daily$energy_generated,2), z=daily$poured_flow, type="scatter3d", mode="markers",color = daily$water_level)
```


```{r}
model_5<- lm(poured_flow ~  lag(influent_flow,2) + lag(energy_generated,2), daily)
summary(model_5)
```

I wonder how good the dam operators are at predicting future influent flow. How often are they proactively draining the reservoir? Next I am going to see if future influent flow is a good predictor of todays poured flow... A two day lead seems to do as well as a 2 day lag. It could just be that poured flow is a real time decision: ie overfull dams are automatically drained. 

```{r}
model_7<- lm(poured_flow ~lead(influent_flow,2), daily)
summary(model_7)

daily %>%  ggplot( aes(y = poured_flow, x=lead(influent_flow,2),color=month)) + 
    geom_point() + 
    stat_smooth(method="lm", se=FALSE)
```
```{r}
daily %>% filter(water_level >450) %>% ggplot(aes(x= date, y = poured_flow, color = influent_flow)) + geom_point()
df <- daily %>% filter(water_level>450)
plot_ly(x=df$influent_flow, y=df$water_level, z=df$month, type="scatter3d", mode="markers",color = df$poured_flow)
```

It's time to try a decision tree. I'm not entirely sure what we will get out of it, but at least for poured flow, cutting the data set will be good.

```{r}
library(party)

png(file = "decision_tree2.png", res=300, height=8, width=14, units="in")

tree1 <- ctree( energy_generated ~ water_level + influent_flow + month,daily, controls = ctree_control(maxdepth = 3))

plot(tree1)
```

**Incorperating Weather Data** 

```{r}
weather <- read.csv('aggregate_weather_data.csv')
weather <- weather %>% mutate(date = as.Date(weather$date)) %>% select(-'X')

weather[weather == Inf | weather == -Inf] <- NA

weather %>%  head()

```

```{r}
df <- merge(weather,daily,by = c('date'))
head(df)
```

```{r}
df %>%  ggplot(aes(x=lag(rain_mm_barra_bonita,3), y=influent_flow)) + geom_point(aes(color = month))
```

```{r}
model_8 <- lm(influent_flow ~ lag(rain_mm_barra_bonita, 0) + lag(rain_mm_barra_bonita, 1)+lag(rain_mm_barra_bonita, 2)+lag(rain_mm_barra_bonita, 3)+lag(rain_mm_barra_bonita, 4)+lag(rain_mm_barra_bonita, 5)+lag(rain_mm_barra_bonita, 6)+lag(rain_mm_barra_bonita, 7)+lag(rain_mm_barra_bonita, 8)+lag(rain_mm_barra_bonita, 9)+lag(rain_mm_barra_bonita, 10)+lag(rain_mm_barra_bonita,11)+lag(rain_mm_barra_bonita, 12), data = df) 

summary(model_8)

```

```{r}
df %>%  ggplot( aes(y = influent_flow, x=lag(rain_mm_ibitinga,0),color=month)) + 
    geom_point() + 
    stat_smooth(method="lm", se=FALSE)
df %>%  ggplot( aes(y = influent_flow, x=lag(rain_mm_ibitinga,3),color=month)) + 
    geom_point() + 
    stat_smooth(method="lm", se=FALSE)

plot_ly(x=lag(df$rain_mm_ibitinga, 3), y=lag(df$rain_mm_ibitinga,2), z=df$influent_flow, type="scatter3d", mode="markers",color = lag(df$water_level,1))
```


```{r}
model_8 <- lm(influent_flow ~ lag(rain_mm_ibitinga, 0) + lag(rain_mm_ibitinga, 1)+lag(rain_mm_ibitinga, 2)+lag(rain_mm_ibitinga, 3)+lag(rain_mm_ibitinga, 4)+lag(rain_mm_ibitinga, 5)+lag(rain_mm_ibitinga, 6)+lag(rain_mm_ibitinga, 7)+lag(rain_mm_ibitinga, 8)+lag(rain_mm_ibitinga, 9)+lag(rain_mm_ibitinga, 10)+lag(rain_mm_ibitinga,11)+lag(rain_mm_ibitinga, 12), data = df)

summary(model_8)

```